#!/usr/bin/env node

/**
 * OiS - Operational Intelligence System
 * Terminal-based OS layer for Carbon6 Platform
 * Part of VLTRN Council - Carbon Domain
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const os = require('os');

// Colors
const BLUE = '\x1b[34m';
const GREEN = '\x1b[32m';
const YELLOW = '\x1b[33m';
const RED = '\x1b[31m';
const GRAY = '\x1b[90m';
const NC = '\x1b[0m';

// Paths
const HOME = os.homedir();
const OIS_DIR = path.join(HOME, '.ois');
const CONFIG_DIR = path.join(OIS_DIR, 'config');
const PLUGINS_DIR = path.join(OIS_DIR, 'plugins');
const DATA_DIR = path.join(OIS_DIR, 'data');
const CACHE_DIR = path.join(OIS_DIR, 'cache');

// Banner
const BANNER = `
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║     ${BLUE}OiS${NC} ${GRAY}- OPERATIONAL INTELLIGENCE SYSTEM${NC}           ║
║                                                           ║
║     ${GRAY}Terminal-First Operating System${NC}                      ║
║     ${GRAY}Built on Carbon6 Platform${NC}                            ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
`;

// Check if OiS is initialized
function isInitialized() {
  return fs.existsSync(OIS_DIR) && fs.existsSync(CONFIG_DIR);
}

// Initialize OiS
function init(mode = 'lite') {
  console.log(`${GRAY}Initializing OiS in ${mode} mode...${NC}\n`);

  // Create directory structure
  [OIS_DIR, CONFIG_DIR, PLUGINS_DIR, DATA_DIR, CACHE_DIR,
   path.join(DATA_DIR, 'metrics'),
   path.join(DATA_DIR, 'logs'),
   path.join(DATA_DIR, 'sessions')
  ].forEach(dir => {
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
      console.log(`${GREEN}  ✓${NC} Created ${dir}`);
    }
  });

  // Create default config
  const config = {
    system: {
      version: '1.0.0',
      mode: mode,
      shell: process.env.SHELL?.includes('zsh') ? 'zsh' : 'bash',
      initialized: new Date().toISOString()
    },
    intelligence: {
      enabled: true,
      auto_optimize: true,
      predictive_mode: true
    },
    carbon6: {
      sdk_path: path.join(HOME, 'carbon-collective'),
      platform_path: path.join(HOME, 'Carbon6'),
      auto_sync: true,
      sync_interval: 30
    },
    council: {
      endpoint: 'https://council.vltrn.dev',
      clearance_level: 'L3-CONFIDENTIAL',
      agents: ['GENESIS', 'SOVEREIGN', 'TECHNE', 'AURUM']
    },
    plugins: {
      auto_update: false,
      allowed_sources: ['https://plugins.vltrn.dev']
    },
    security: {
      encryption: 'AES-256-GCM',
      audit_logging: true,
      secure_mode: true
    }
  };

  fs.writeFileSync(
    path.join(CONFIG_DIR, 'ois.json'),
    JSON.stringify(config, null, 2)
  );
  console.log(`${GREEN}  ✓${NC} Created configuration`);

  // Create plugins registry
  const pluginsRegistry = {
    installed: [],
    available: [
      { name: 'ois-carbon', version: '1.0.0', description: 'Carbon6 SDK integration' },
      { name: 'ois-council', version: '1.0.0', description: 'VLTRN Council agents' },
      { name: 'ois-nvidia', version: '1.0.0', description: 'GPU acceleration' },
      { name: 'ois-flow', version: '1.0.0', description: 'Workflow automation' },
      { name: 'ois-intel', version: '1.0.0', description: 'Intelligence gathering' },
      { name: 'ois-secure', version: '1.0.0', description: 'Security & encryption' }
    ]
  };

  fs.writeFileSync(
    path.join(CONFIG_DIR, 'plugins.json'),
    JSON.stringify(pluginsRegistry, null, 2)
  );
  console.log(`${GREEN}  ✓${NC} Created plugin registry`);

  console.log(`\n${GREEN}✓ OiS initialized successfully!${NC}\n`);
  console.log(`${GRAY}Next steps:${NC}`);
  console.log(`  ${BLUE}ois status${NC}       - View system status`);
  console.log(`  ${BLUE}ois plugins${NC}      - Manage plugins`);
  console.log(`  ${BLUE}ois agents${NC}       - List available agents`);
  console.log(`  ${BLUE}ois task "..."${NC}   - Execute natural language task`);
  console.log('');
}

// Show status
function status() {
  if (!isInitialized()) {
    console.log(`${RED}✗ OiS is not initialized${NC}`);
    console.log(`${GRAY}Run: ${BLUE}ois init${NC}`);
    return;
  }

  const config = JSON.parse(fs.readFileSync(path.join(CONFIG_DIR, 'ois.json')));

  console.log(`${GRAY}╔═══════════════════════════════════════╗${NC}`);
  console.log(`${GRAY}║${NC}  ${GREEN}OiS System Status${NC}                    ${GRAY}║${NC}`);
  console.log(`${GRAY}╚═══════════════════════════════════════╝${NC}\n`);

  console.log(`${GRAY}Version:${NC}        ${config.system.version}`);
  console.log(`${GRAY}Mode:${NC}           ${config.system.mode}`);
  console.log(`${GRAY}Shell:${NC}          ${config.system.shell}`);
  console.log(`${GRAY}Initialized:${NC}    ${new Date(config.system.initialized).toLocaleString()}`);
  console.log('');

  // Carbon6 status
  const carbonExists = fs.existsSync(config.carbon6.sdk_path);
  const platformExists = fs.existsSync(config.carbon6.platform_path);

  console.log(`${GRAY}Carbon6 Integration:${NC}`);
  console.log(`  SDK:      ${carbonExists ? GREEN + '✓' : RED + '✗'}${NC} ${config.carbon6.sdk_path}`);
  console.log(`  Platform: ${platformExists ? GREEN + '✓' : RED + '✗'}${NC} ${config.carbon6.platform_path}`);
  console.log('');

  // Plugins
  const plugins = JSON.parse(fs.readFileSync(path.join(CONFIG_DIR, 'plugins.json')));
  console.log(`${GRAY}Plugins:${NC}        ${plugins.installed.length} installed`);

  // Intelligence
  console.log(`${GRAY}Intelligence:${NC}   ${config.intelligence.enabled ? GREEN + 'Enabled' : GRAY + 'Disabled'}${NC}`);
  console.log(`${GRAY}Auto-optimize:${NC}  ${config.intelligence.auto_optimize ? GREEN + 'On' : GRAY + 'Off'}${NC}`);
  console.log('');
}

// List plugins
function listPlugins() {
  if (!isInitialized()) {
    console.log(`${RED}✗ OiS is not initialized${NC}`);
    return;
  }

  const plugins = JSON.parse(fs.readFileSync(path.join(CONFIG_DIR, 'plugins.json')));

  console.log(`\n${GREEN}Installed Plugins:${NC}`);
  if (plugins.installed.length === 0) {
    console.log(`  ${GRAY}No plugins installed${NC}`);
  } else {
    plugins.installed.forEach(p => {
      console.log(`  ${GREEN}✓${NC} ${p.name} v${p.version} ${p.enabled ? '' : GRAY + '(disabled)' + NC}`);
    });
  }

  console.log(`\n${GRAY}Available Plugins:${NC}`);
  plugins.available.forEach(p => {
    const installed = plugins.installed.find(i => i.name === p.name);
    if (!installed) {
      console.log(`  ${GRAY}○${NC} ${p.name} v${p.version} - ${p.description}`);
    }
  });
  console.log('');
}

// Install plugin
function installPlugin(name) {
  if (!isInitialized()) {
    console.log(`${RED}✗ OiS is not initialized${NC}`);
    return;
  }

  const pluginsPath = path.join(CONFIG_DIR, 'plugins.json');
  const plugins = JSON.parse(fs.readFileSync(pluginsPath));

  const available = plugins.available.find(p => p.name === name);
  if (!available) {
    console.log(`${RED}✗ Plugin '${name}' not found${NC}`);
    return;
  }

  const alreadyInstalled = plugins.installed.find(p => p.name === name);
  if (alreadyInstalled) {
    console.log(`${YELLOW}⚠ Plugin '${name}' is already installed${NC}`);
    return;
  }

  console.log(`${GRAY}Installing ${name}...${NC}`);

  plugins.installed.push({
    name: name,
    version: available.version,
    enabled: true,
    installed: new Date().toISOString()
  });

  fs.writeFileSync(pluginsPath, JSON.stringify(plugins, null, 2));
  console.log(`${GREEN}✓ Plugin '${name}' installed successfully${NC}`);
}

// List agents
function listAgents() {
  console.log(`\n${GREEN}Available VLTRN Council Agents:${NC}\n`);

  const agents = [
    { tier: 'L5-BLACK', name: 'GENESIS', desc: 'Divine Orchestrator' },
    { tier: 'L4-RESTRICTED', name: 'SOVEREIGN', desc: 'Strategic Command' },
    { tier: 'L4-RESTRICTED', name: 'MNEMOS', desc: 'Memory & Knowledge' },
    { tier: 'L4-RESTRICTED', name: 'AEGIS', desc: 'Security Guardian' },
    { tier: 'L4-RESTRICTED', name: 'PRAXIS', desc: 'Operations Director' },
    { tier: 'L4-RESTRICTED', name: 'TRUST_DIRECTOR', desc: 'Compliance & Trust' },
    { tier: 'L3-CONFIDENTIAL', name: 'TECHNE', desc: 'Technology & Development' },
    { tier: 'L3-CONFIDENTIAL', name: 'AURUM', desc: 'Finance & Treasury' },
    { tier: 'L3-CONFIDENTIAL', name: 'SOPHIA', desc: 'Research & Intelligence' },
    { tier: 'L3-CONFIDENTIAL', name: 'MERCATOR', desc: 'Marketing & Growth' },
    { tier: 'L3-CONFIDENTIAL', name: 'MELODIA', desc: 'Creative & Media' },
    { tier: 'L3-CONFIDENTIAL', name: 'DATUM', desc: 'Data & Analytics' }
  ];

  agents.forEach(a => {
    const color = a.tier === 'L5-BLACK' ? RED : a.tier === 'L4-RESTRICTED' ? YELLOW : BLUE;
    console.log(`  ${color}${a.name.padEnd(16)}${NC} ${GRAY}[${a.tier}]${NC} - ${a.desc}`);
  });

  console.log(`\n${GRAY}Usage:${NC}`);
  console.log(`  ${BLUE}ois agents invoke TECHNE "build API"${NC}`);
  console.log(`  ${BLUE}ois task "analyze sales data"${NC} ${GRAY}# Auto-routes to best agent${NC}`);
  console.log('');
}

// Execute task
function executeTask(taskDescription) {
  console.log(`${GRAY}Analyzing task...${NC}`);
  console.log(`${BLUE}Task:${NC} ${taskDescription}\n`);

  // Simulate agent routing
  console.log(`${GRAY}[GENESIS] Parsing intent...${NC}`);
  console.log(`${GRAY}[GENESIS] Routing to appropriate agent...${NC}\n`);

  console.log(`${YELLOW}⚠ Task execution requires full Council integration${NC}`);
  console.log(`${GRAY}This feature will be available in the next release${NC}\n`);

  console.log(`${GRAY}For now, you can manually invoke agents:${NC}`);
  console.log(`  ${BLUE}ois agents invoke <AGENT_NAME> "<task>"${NC}`);
  console.log('');
}

// Show help
function showHelp() {
  console.log(BANNER);
  console.log(`${GREEN}Usage:${NC} ois <command> [options]\n`);

  console.log(`${GREEN}System Commands:${NC}`);
  console.log(`  ${BLUE}init${NC}              Initialize OiS on this system`);
  console.log(`  ${BLUE}status${NC}            Show system status`);
  console.log(`  ${BLUE}version${NC}           Show version information`);
  console.log(`  ${BLUE}config${NC}            Show configuration`);
  console.log('');

  console.log(`${GREEN}Plugin Commands:${NC}`);
  console.log(`  ${BLUE}plugins${NC}           List all plugins`);
  console.log(`  ${BLUE}plugins install${NC}   Install a plugin`);
  console.log(`  ${BLUE}plugins remove${NC}    Remove a plugin`);
  console.log('');

  console.log(`${GREEN}Agent Commands:${NC}`);
  console.log(`  ${BLUE}agents${NC}            List available agents`);
  console.log(`  ${BLUE}agents invoke${NC}     Invoke specific agent`);
  console.log('');

  console.log(`${GREEN}Task Execution:${NC}`);
  console.log(`  ${BLUE}task "<desc>"${NC}     Execute natural language task`);
  console.log('');

  console.log(`${GREEN}Carbon6 Integration:${NC}`);
  console.log(`  ${BLUE}carbon status${NC}     Carbon SDK status`);
  console.log(`  ${BLUE}carbon sync${NC}       Force sync`);
  console.log('');

  console.log(`${GRAY}Examples:${NC}`);
  console.log(`  ${BLUE}ois init${NC}`);
  console.log(`  ${BLUE}ois plugins install ois-carbon${NC}`);
  console.log(`  ${BLUE}ois task "deploy my app to production"${NC}`);
  console.log(`  ${BLUE}ois agents invoke TECHNE "create REST API"${NC}`);
  console.log('');
}

// Main CLI router
function main() {
  const args = process.argv.slice(2);
  const command = args[0];
  const subcommand = args[1];
  const param = args[2];

  if (!command || command === 'help' || command === '--help' || command === '-h') {
    showHelp();
    return;
  }

  switch (command) {
    case 'init':
      init(subcommand || 'lite');
      break;

    case 'status':
      status();
      break;

    case 'version':
      console.log(`${GRAY}OiS${NC} v1.0.0 (lite)`);
      console.log(`${GRAY}Carbon6 Platform Integration${NC}`);
      console.log(`${GRAY}Part of VLTRN Council - Carbon Domain${NC}`);
      break;

    case 'plugins':
      if (subcommand === 'install' && param) {
        installPlugin(param);
      } else {
        listPlugins();
      }
      break;

    case 'agents':
      if (subcommand === 'invoke' && param) {
        console.log(`${YELLOW}⚠ Agent invocation requires Council API integration${NC}`);
      } else {
        listAgents();
      }
      break;

    case 'task':
      if (subcommand) {
        executeTask(subcommand);
      } else {
        console.log(`${RED}✗ Task description required${NC}`);
        console.log(`${GRAY}Usage: ${BLUE}ois task "your task description"${NC}`);
      }
      break;

    case 'carbon':
      if (subcommand === 'status') {
        try {
          execSync('carbon status', { stdio: 'inherit' });
        } catch (e) {
          console.log(`${RED}✗ Carbon SDK not available${NC}`);
        }
      } else {
        console.log(`${GRAY}Carbon6 subcommands: ${BLUE}status, sync${NC}`);
      }
      break;

    default:
      console.log(`${RED}✗ Unknown command: ${command}${NC}`);
      console.log(`${GRAY}Run ${BLUE}ois help${NC} for usage information`);
  }
}

// Run
main();
